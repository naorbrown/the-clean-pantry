---
import PageLayout from '../../layouts/PageLayout.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import ContentCard from '../../components/ui/ContentCard.astro';
import SectionHeader from '../../components/ui/SectionHeader.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const ingredients = await getCollection('ingredients');
  return ingredients.map((ingredient) => ({
    params: { slug: ingredient.id },
    props: { ingredient },
  }));
}

const { ingredient } = Astro.props;
const { Content } = await render(ingredient);
const { name, description, category, scienceSummary, safetyNotes, storageInstructions, shelfLife } = ingredient.data;

const allRecipes = await getCollection('recipes', ({ data }) => !data.draft);
const relatedRecipes = allRecipes.filter((r) =>
  r.data.ingredients.some((i) => i.name.toLowerCase().includes(name.toLowerCase()))
);

const propertyCards = [
  { icon: 'beaker', title: 'Why it works', content: scienceSummary, show: !!scienceSummary },
  { icon: 'shield', title: 'Safety notes', content: safetyNotes, show: safetyNotes?.length > 0, isList: true },
  { icon: 'archive', title: 'Storage', content: storageInstructions, show: !!storageInstructions },
  { icon: 'clock', title: 'Shelf life', content: shelfLife, show: !!shelfLife },
];
---

<PageLayout title={name} description={description}>
  <div class="max-w-3xl mx-auto px-4 sm:px-6 py-8 sm:py-12" data-pagefind-body>
    <Breadcrumb items={[
      { label: 'Ingredients', href: '/ingredients/' },
      { label: name },
    ]} />

    <div class="mt-4 mb-8">
      <span class="inline-block text-xs font-medium text-sage-dark dark:text-sage-light uppercase tracking-wider bg-sage/10 dark:bg-sage/5 rounded-full px-3 py-1 mb-3 capitalize">{category}</span>
      <h1 class="font-serif text-2xl sm:text-3xl font-bold text-bark dark:text-dark-text mb-2">
        {name}
      </h1>
      <p class="text-bark-light/80 dark:text-dark-text/70 text-lg">{description}</p>
    </div>

    <!-- Property cards -->
    <div class="grid sm:grid-cols-2 gap-4 mb-10">
      {propertyCards.map(({ icon, title, content, show, isList }) => show && (
        <div class="rounded-xl border border-cream-dark dark:border-dark-surface p-5">
          <div class="flex items-center gap-2 mb-2">
            {icon === 'beaker' && (
              <svg class="w-4 h-4 text-sage-dark dark:text-sage-light" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M5 14.5l-1.703 4.258A1.125 1.125 0 004.348 20.5h15.304a1.125 1.125 0 001.051-1.742L19 14.5" />
              </svg>
            )}
            {icon === 'shield' && (
              <svg class="w-4 h-4 text-terracotta dark:text-terracotta-light" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
            )}
            {icon === 'archive' && (
              <svg class="w-4 h-4 text-honey-dark dark:text-honey" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
              </svg>
            )}
            {icon === 'clock' && (
              <svg class="w-4 h-4 text-sky dark:text-sky-light" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12,6 12,12 16,14" />
              </svg>
            )}
            <h3 class="font-serif text-sm font-semibold text-bark dark:text-dark-text">{title}</h3>
          </div>
          {isList ? (
            <ul class="text-sm text-bark-light/80 dark:text-dark-text/70 space-y-1">
              {(content as string[]).map((item: string) => (
                <li class="flex items-start gap-2">
                  <span class="text-terracotta mt-0.5 shrink-0">â€¢</span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-sm text-bark-light/80 dark:text-dark-text/70">{content}</p>
          )}
        </div>
      ))}
    </div>

    <!-- Body content -->
    <div class="prose prose-bark dark:prose-invert max-w-none mb-10">
      <Content />
    </div>

    <!-- Related recipes -->
    {relatedRecipes.length > 0 && (
      <section class="border-t border-cream-dark dark:border-dark-surface pt-8">
        <SectionHeader title={`Recipes using ${name}`} />
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
          {relatedRecipes.slice(0, 6).map((recipe) => (
            <ContentCard
              href={`/recipes/${recipe.id}/`}
              title={recipe.data.title}
              description={recipe.data.description}
              category={recipe.data.category}
              type="recipe"
              totalTime={recipe.data.totalTime}
              difficulty={recipe.data.difficulty}
              ingredientCount={recipe.data.ingredients.length}
            />
          ))}
        </div>
      </section>
    )}
  </div>
</PageLayout>
