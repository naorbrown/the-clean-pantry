---
import { url } from '../../lib/utils';
const pagefindBasePath = url('/pagefind/');
---

<dialog id="search-dialog" class="search-overlay fixed inset-0 w-full h-full max-w-none max-h-none m-0 p-0 bg-transparent">
  <div class="w-full sm:max-w-2xl mx-auto mt-0 sm:mt-20 px-0 sm:px-4 h-full sm:h-auto">
    <div class="bg-dark-bg sm:rounded-xl rounded-none shadow-xl overflow-hidden border border-dark-surface flex flex-col max-h-full sm:max-h-[80vh]">
      <div class="flex items-center justify-between px-4 pt-3 pb-1 flex-shrink-0">
        <div class="flex items-center gap-2 text-dark-text/40">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
          </svg>
          <span class="text-sm font-medium">Try "vinegar cleaner" or "bathroom"</span>
        </div>
        <button
          id="search-close"
          type="button"
          class="p-1.5 rounded-lg text-dark-text/40 hover:text-dark-text hover:bg-dark-surface transition-colors"
          aria-label="Close search"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="search-container" class="px-4 pb-4 overflow-y-auto flex-1 min-h-0"></div>
    </div>
  </div>
</dialog>

<script define:vars={{ pagefindBasePath }}>
  const dialog = document.getElementById('search-dialog');
  const closeBtn = document.getElementById('search-close');
  let pagefindInitialized = false;

  function openSearch() {
    dialog?.showModal();
    if (!pagefindInitialized && typeof window.PagefindUI !== 'undefined') {
      new window.PagefindUI({
        element: '#search-container',
        showImages: false,
        showSubResults: false,
        resetStyles: false,
        basePath: pagefindBasePath,
      });
      pagefindInitialized = true;
    }
    setTimeout(() => {
      const input = dialog?.querySelector('.pagefind-ui__search-input');
      input?.focus();
    }, 100);
  }

  function closeSearch() {
    dialog?.close();
  }

  closeBtn?.addEventListener('click', closeSearch);

  dialog?.addEventListener('click', (e) => {
    if (e.target === dialog) closeSearch();
  });

  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      dialog?.open ? closeSearch() : openSearch();
    }
    if (e.key === 'Escape' && dialog?.open) {
      closeSearch();
    }
  });

  window.__openSearch = openSearch;
</script>
